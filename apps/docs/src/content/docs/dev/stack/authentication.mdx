---
title: Authentication
description: How authentication works across our applications using Supabase Auth and Astro
---

## Overview

Our authentication system is built on top of [Supabase Auth](https://supabase.com/docs/guides/auth), integrated with Astro for routing and state management. The system is implemented in our shared `@sfh/backend` package, providing a consistent, secure, and type-safe authentication experience across all applications.

## Architecture

The authentication system consists of several key components working together:

### 1. Backend Authentication (`@sfh/backend`)

The core authentication functionality is centralized in our backend package:

```typescript
// Create an auth instance
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

export class Auth {
  private supabaseClient: SupabaseClient<Database>;

  constructor(supabaseUrl: string, supabaseKey: string) {
    this.supabaseClient = createClient<Database>(supabaseUrl, supabaseKey, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
      },
    });
  }

  // Core authentication methods
  async signInWithEmail(email: string, password: string) {
    const { data, error } = await this.supabaseClient.auth.signInWithPassword({
      email,
      password,
    });
    if (error) throw error;
    return { user: data.user, session: data.session };
  }

  async signInWithOAuth(provider: 'github' | 'google') {
    const { data, error } = await this.supabaseClient.auth.signInWithOAuth({
      provider,
    });
    if (error) throw error;
    return data;
  }

  async signUp(email: string, password: string) {
    const { data, error } = await this.supabaseClient.auth.signUp({
      email,
      password,
    });
    if (error) throw error;
    return { user: data.user, session: data.session };
  }

  async signOut() {
    const { error } = await this.supabaseClient.auth.signOut();
    if (error) throw error;
  }
}
```

The `Auth` class provides:

- User management and sessions
- OAuth integration (GitHub, Google)
- JWT tokens for session management
- Row Level Security (RLS) integration
- Type-safe authentication methods

### 2. Framework Integration

Our authentication system provides built-in support for both Svelte stores and Astro:

```typescript
// Svelte Store Integration
export function createSvelteAuthStore(options: {
  auth: Auth;
  createStore: (value: AuthStore) => any;
}) {
  const store = options.createStore({
    user: null,
    loading: true,
    error: null,
  });

  async function init() {
    try {
      const session = await options.auth.getSession();
      store.set({ user: session?.user ?? null, loading: false, error: null });

      options.auth.onAuthStateChange((user) => {
        store.set({ user, loading: false, error: null });
      });
    } catch (error) {
      store.set({
        user: null,
        loading: false,
        error: error instanceof Error ? error : new Error('Unknown error'),
      });
    }
  }

  init();
  return store;
}

// Astro Store Integration
export function createAstroAuthStore(auth: Auth) {
  let store: AuthStore = {
    user: null,
    loading: true,
    error: null,
  };

  async function initialize() {
    try {
      const session = await auth.getSession();
      store = {
        user: session?.user ?? null,
        loading: false,
        error: null,
      };
    } catch (error) {
      store = {
        user: null,
        loading: false,
        error: error instanceof Error ? error : new Error('Unknown error'),
      };
    }
  }

  return {
    getStore: () => store,
    initialize,
  };
}
```

### 3. Frontend Implementation

Applications can implement authentication using these main components:

#### Auth Instance

```typescript
// lib/auth.ts
import { Auth } from '@sfh/backend';

export const auth = new Auth(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// Re-export auth methods for convenience
export const { signInWithEmail, signInWithOAuth, signUp, signOut } = auth;
```

#### Auth Store

```typescript
// lib/stores/auth.ts
import { writable } from 'svelte/store';
import { auth } from '../auth';
import { createSvelteAuthStore } from '@sfh/backend';

export const authStore = createSvelteAuthStore({
  auth,
  createStore: writable,
});
```

#### Login Page

```astro
---
// pages/login.astro
import LoginForm from '../components/LoginForm.svelte';
import Layout from '../layouts/Layout.astro';
---

<Layout title="Login">
  <div class="min-h-screen hero bg-base-200">
    <div class="hero-content flex-col">
      <div class="text-center mb-8">
        <h1 class="text-5xl font-bold">Welcome Back!</h1>
        <p class="py-6 text-base-content/60">Sign in to access your dashboard</p>
      </div>

      <LoginForm client:load />
    </div>
  </div>
</Layout>
```

## Security Considerations

### Environment Variables

```bash
# Required for authentication
PUBLIC_SUPABASE_URL="your-project-url"
PUBLIC_SUPABASE_ANON_KEY="your-anon-key"

# For secure server-side operations
SUPABASE_SERVICE_KEY="your-service-key" # Never expose this
```

### Row Level Security (RLS)

All data access is controlled through RLS policies that integrate with the authentication system:

```sql
-- Example: Users can only access their own data
create policy "Users can only access their own data"
  on public.users
  for select
  using (auth.uid() = id);
```

## Best Practices

1. **Authentication Setup**

   - Always use the shared `@sfh/backend` package for authentication
   - Configure environment variables properly
   - Initialize auth early in your application

2. **Route Protection**

   - Use middleware or layout components for protected routes
   - Use RLS policies as the primary security mechanism
   - Never rely solely on client-side auth checks

3. **Error Handling**

   - Always handle authentication errors gracefully
   - Provide clear feedback to users
   - Log authentication failures appropriately

4. **State Management**

   - Use the provided auth store for state management
   - Avoid storing sensitive auth data in local storage
   - Clear auth state properly on logout

5. **Performance**
   - Use `client:load` directive for auth components
   - Implement loading states for better UX
   - Cache auth state appropriately

## Troubleshooting

Common issues and their solutions:

1. **Session Not Persisting**

   - Check if cookies are enabled
   - Verify SSL configuration
   - Ensure correct environment variables

2. **Protected Route Flashing**

   - Use `client:load` directive
   - Implement proper loading states
   - Check auth store initialization

3. **RLS Policy Issues**
   - Verify policy syntax
   - Check user authentication state
   - Test policies in Supabase Studio
